<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>××©×—×§ ×”×§×œ×“×” - Typing Game</title>
    <link rel="stylesheet" href="styles.css">
    <script src="lesson-manager.js" onerror="console.log('lesson-manager.js not found, using basic mode')"></script>
</head>
<body class="typing-body">
    <div class="container">
        <h1>âŒ¨ï¸ ××©×—×§ ×”×§×œ×“×” - Typing Game</h1>
        
        <div id="lessonSelector"></div>

        <div class="score-section">
            <div class="score-box">
                <span>âœ… × ×›×•× ×•×ª</span>
                <span class="score-number" id="correctScore">0</span>
            </div>
            <div class="score-box">
                <span>âŒ ×˜×¢×•×™×•×ª</span>
                <span class="score-number" id="wrongScore">0</span>
            </div>
        </div>

        <div class="game-card" id="gameArea">
            <div class="word-display">
                <button class="speaker-btn" id="speakerBtn" onclick="speakWord()" title="×”×§×¨× ××ª ×”××™×œ×”">
                    ğŸ”Š
                </button>
                <div class="english-word" id="englishWord">Loading...</div>
                <div class="progress-text" id="progressText">××™×œ×” 1 ××ª×•×š 63</div>
            </div>

            <div class="input-section">
                <div class="input-label">×ª×¨×’× ×œ×¢×‘×¨×™×ª:</div>
                <input 
                    type="text" 
                    class="answer-input" 
                    id="answerInput" 
                    placeholder="×”×§×œ×“ ××ª ×”×ª×¨×’×•× ×›××Ÿ..."
                    autocomplete="off"
                >
            </div>

            <div class="feedback" id="feedback"></div>

            <div class="controls">
                <button class="btn btn-submit" id="submitBtn" onclick="checkAnswer()">
                    âœ“ ×‘×“×•×§ ×ª×©×•×‘×”
                </button>
                <button class="btn btn-skip" id="skipBtn" onclick="skipWord()">
                    â­ï¸ ×“×œ×’
                </button>
                <button class="btn btn-next" id="nextBtn" onclick="nextWord()" style="display: none;">
                    â¡ï¸ ×”×‘×
                </button>
            </div>
        </div>

        <div class="complete-screen" id="completeScreen">
            <h2>ğŸ‰ ×¡×™×™××ª!</h2>
            <div class="final-stats">
                <div>âœ… ×ª×©×•×‘×•×ª × ×›×•× ×•×ª: <span class="stat-highlight" id="finalCorrect">0</span></div>
                <div>âŒ ×˜×¢×•×™×•×ª: <span class="stat-highlight" id="finalWrong">0</span></div>
                <div>â­ï¸ ×“×™×œ×•×’×™×: <span class="stat-highlight" id="finalSkipped">0</span></div>
                <div>ğŸ“Š ×¦×™×•×Ÿ: <span class="stat-highlight" id="finalPercentage">0%</span></div>
            </div>
            <div>
                <button class="restart-btn" onclick="restartGame()">ğŸ”„ ×©×—×§ ×©×•×‘ (×›×œ ×”××™×œ×™×)</button>
                <button class="retry-btn" id="retryWrongBtn" onclick="retryWrong()" style="display: none;">
                    ğŸ’ª ×ª×¨×’×œ ××™×œ×™× ×©×˜×¢×™×ª
                </button>
            </div>
        </div>

        <div class="hint">
            ğŸ’¡ ×œ×—×¥ ×¢×œ ğŸ”Š ×›×“×™ ×œ×©××•×¢ ××ª ×”××™×œ×” | ×”×§×œ×“ ××ª ×”×ª×¨×’×•× ×‘×¢×‘×¨×™×ª ×•×œ×—×¥ Enter
        </div>
    </div>

    <script type="module">
        // ============================================
        // IMPORTS
        // ============================================
        import { vocabularyService } from '../shared/vocabulary-service.js';
        import { createOfflineIndicator, showOfflineIndicator } from '../shared/offline-indicator.js';

        // ============================================
        // JSON ××•×˜××¢ (×‘×¨×™×¨×ª ××—×“×œ)
        // ============================================
        const EMBEDDED_VOCABULARY = [
            { "english": "perfect", "hebrew": "××•×©×œ×", "lesson": 1 },
            { "english": "inside", "hebrew": "×‘×¤× ×™×", "lesson": 1 },
            { "english": "area", "hebrew": "××–×•×¨", "lesson": 1 },
            { "english": "bridge", "hebrew": "×’×©×¨", "lesson": 1 },
            { "english": "danger", "hebrew": "×¡×›× ×”", "lesson": 1 }
        ];

        let vocabulary = EMBEDDED_VOCABULARY;
        let words = [];
        let currentIndex = 0;
        let correctCount = 0;
        let wrongCount = 0;
        let skippedCount = 0;
        let wrongWords = [];
        let hasAnswered = false;
        let isRetryMode = false;

        const encouragingMessages = [
            "ğŸ‰ ××¦×•×™×Ÿ!",
            "ğŸ’ª ×›×œ ×”×›×‘×•×“!",
            "â­ × ×”×“×¨!",
            "ğŸŒŸ ××¢×•×œ×”!",
            "ğŸ‘ ×™×¤×” ×××•×“!",
            "ğŸ”¥ ××©!",
            "ğŸš€ ×¤×¦×¦×”!",
            "ğŸ’ ××•×©×œ×!",
            "ğŸ† ××œ×•×£!",
            "âœ¨ ×™×¤×”!"
        ];

        function shuffleArray(array) {
            const newArray = [...array];
            for (let i = newArray.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
            }
            return newArray;
        }

        function normalizeHebrew(text) {
            // Remove extra spaces, trim, and normalize
            return text.trim().replace(/\s+/g, ' ').toLowerCase();
        }

        function speakWord() {
            const word = words[currentIndex];
            if (!word) return;
            
            // Check if speech synthesis is supported
            if ('speechSynthesis' in window) {
                // Cancel any ongoing speech
                window.speechSynthesis.cancel();
                
                const utterance = new SpeechSynthesisUtterance(word.english);
                utterance.lang = 'en-US';
                utterance.rate = 0.8; // Slower for learning
                
                // Add animation
                const btn = document.getElementById('speakerBtn');
                btn.classList.add('playing');
                
                utterance.onend = () => {
                    btn.classList.remove('playing');
                };
                
                window.speechSynthesis.speak(utterance);
            } else {
                alert('×”×“×¤×“×¤×Ÿ ×©×œ×š ×œ× ×ª×•××š ×‘×”×§×¨××ª ×˜×§×¡×˜');
            }
        }

        function isAnswerCorrect(userAnswer, correctAnswer) {
            const normalized1 = normalizeHebrew(userAnswer);
            const normalized2 = normalizeHebrew(correctAnswer);
            
            // Check if answers are the same
            if (normalized1 === normalized2) return true;
            
            // Check if correctAnswer has multiple options (separated by comma)
            const options = correctAnswer.split(',').map(opt => normalizeHebrew(opt));
            return options.some(opt => opt === normalized1);
        }

        // 3-tier fallback: Firebase -> JSON -> Embedded
        async function loadVocabulary() {
            // Create offline indicator
            createOfflineIndicator();

            // Set up status callback
            vocabularyService.setStatusCallback(({ isOnline, source }) => {
                showOfflineIndicator(!isOnline);
            });

            // Try VocabularyService (Firebase -> JSON -> null)
            const data = await vocabularyService.getEnglishVocabulary();

            if (data && data.vocabulary && data.vocabulary.length > 0) {
                // Check if LessonManager exists
                if (typeof LessonManager !== 'undefined') {
                    await LessonManager.init(data.vocabulary);
                    LessonManager.createLessonSelector('lessonSelector', onLessonChange);
                } else {
                    vocabulary = data.vocabulary;
                }
                console.log('âœ… Vocabulary loaded from ' + vocabularyService.getLastSource());
                initializeGame();
                return;
            }

            // Fallback to embedded vocabulary
            showOfflineIndicator(true);
            if (typeof LessonManager !== 'undefined') {
                await LessonManager.init(EMBEDDED_VOCABULARY);
                LessonManager.createLessonSelector('lessonSelector', onLessonChange);
            }
            console.log('â„¹ï¸ Using embedded vocabulary');
            initializeGame();
        }

        function onLessonChange(lesson) {
            correctCount = 0;
            wrongCount = 0;
            skippedCount = 0;
            wrongWords = [];
            document.getElementById('correctScore').textContent = '0';
            document.getElementById('wrongScore').textContent = '0';
            initializeGame();
        }

        function initializeGame() {
            if (typeof LessonManager !== 'undefined') {
                vocabulary = LessonManager.getCurrentVocabulary();
            }
            words = shuffleArray([...vocabulary]);
            currentIndex = 0;
            displayWord();
        }

        function displayWord() {
            if (currentIndex >= words.length) {
                showCompleteScreen();
                return;
            }

            hasAnswered = false;
            const word = words[currentIndex];
            
            document.getElementById('englishWord').textContent = word.english;
            document.getElementById('progressText').textContent = `××™×œ×” ${currentIndex + 1} ××ª×•×š ${words.length}`;
            document.getElementById('answerInput').value = '';
            document.getElementById('answerInput').className = 'answer-input';
            document.getElementById('answerInput').disabled = false;
            document.getElementById('feedback').innerHTML = '';
            document.getElementById('feedback').className = 'feedback';
            
            document.getElementById('submitBtn').style.display = 'inline-block';
            document.getElementById('skipBtn').style.display = 'inline-block';
            document.getElementById('nextBtn').style.display = 'none';
            
            // Focus on input
            document.getElementById('answerInput').focus();
        }

        function checkAnswer() {
            if (hasAnswered) return;
            
            const userAnswer = document.getElementById('answerInput').value.trim();
            if (!userAnswer) {
                alert('×× × ×”×§×œ×“ ×ª×©×•×‘×”');
                return;
            }
            
            hasAnswered = true;
            const word = words[currentIndex];
            const input = document.getElementById('answerInput');
            const feedback = document.getElementById('feedback');
            
            input.disabled = true;
            document.getElementById('submitBtn').style.display = 'none';
            document.getElementById('skipBtn').style.display = 'none';
            document.getElementById('nextBtn').style.display = 'inline-block';
            
            if (isAnswerCorrect(userAnswer, word.hebrew)) {
                input.classList.add('correct');
                correctCount++;
                document.getElementById('correctScore').textContent = correctCount;
                
                const randomMessage = encouragingMessages[Math.floor(Math.random() * encouragingMessages.length)];
                feedback.innerHTML = `<div class="feedback-icon">âœ…</div><div>${randomMessage}</div>`;
                feedback.className = 'feedback correct';
            } else {
                input.classList.add('wrong');
                wrongCount++;
                document.getElementById('wrongScore').textContent = wrongCount;
                
                // Track wrong word
                if (!wrongWords.find(w => w.english === word.english)) {
                    wrongWords.push(word);
                }
                
                feedback.innerHTML = `
                    <div class="feedback-icon">âŒ</div>
                    <div>×œ× × ×›×•×Ÿ</div>
                    <div class="correct-answer">×”×ª×©×•×‘×” ×”× ×›×•× ×”: ${word.hebrew}</div>
                `;
                feedback.className = 'feedback wrong';
            }
        }

        function skipWord() {
            if (hasAnswered) return;
            
            const word = words[currentIndex];
            const feedback = document.getElementById('feedback');
            
            skippedCount++;
            
            // Track as wrong word for retry
            if (!wrongWords.find(w => w.english === word.english)) {
                wrongWords.push(word);
            }
            
            feedback.innerHTML = `
                <div class="feedback-icon">â­ï¸</div>
                <div>×“×™×œ×’×ª</div>
                <div class="correct-answer">×”×ª×©×•×‘×”: ${word.hebrew}</div>
            `;
            feedback.className = 'feedback';
            
            hasAnswered = true;
            document.getElementById('answerInput').disabled = true;
            document.getElementById('submitBtn').style.display = 'none';
            document.getElementById('skipBtn').style.display = 'none';
            document.getElementById('nextBtn').style.display = 'inline-block';
        }

        function nextWord() {
            currentIndex++;
            displayWord();
        }

        function showCompleteScreen() {
            document.getElementById('gameArea').style.display = 'none';
            document.getElementById('completeScreen').style.display = 'block';
            
            const total = words.length;
            const percentage = Math.round((correctCount / total) * 100);
            
            document.getElementById('finalCorrect').textContent = correctCount;
            document.getElementById('finalWrong').textContent = wrongCount;
            document.getElementById('finalSkipped').textContent = skippedCount;
            document.getElementById('finalPercentage').textContent = `${percentage}%`;
            
            // Show retry button if there are wrong words
            if (wrongWords.length > 0) {
                const retryBtn = document.getElementById('retryWrongBtn');
                retryBtn.style.display = 'inline-block';
                retryBtn.textContent = `ğŸ’ª ×ª×¨×’×œ ××™×œ×™× ×©×˜×¢×™×ª (${wrongWords.length} ××™×œ×™×)`;
            }
        }

        function restartGame() {
            words = shuffleArray([...vocabulary]);
            currentIndex = 0;
            correctCount = 0;
            wrongCount = 0;
            skippedCount = 0;
            wrongWords = [];
            isRetryMode = false;
            
            document.getElementById('correctScore').textContent = '0';
            document.getElementById('wrongScore').textContent = '0';
            document.getElementById('gameArea').style.display = 'block';
            document.getElementById('completeScreen').style.display = 'none';
            
            displayWord();
        }

        function retryWrong() {
            words = shuffleArray([...wrongWords]);
            wrongWords = []; // Reset wrong words for the new retry game
            currentIndex = 0;
            correctCount = 0;
            wrongCount = 0;
            skippedCount = 0;
            isRetryMode = true;
            
            document.getElementById('correctScore').textContent = '0';
            document.getElementById('wrongScore').textContent = '0';
            document.getElementById('gameArea').style.display = 'block';
            document.getElementById('completeScreen').style.display = 'none';
            
            displayWord();
        }

        // Enter key support
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('answerInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    if (!hasAnswered) {
                        checkAnswer();
                    } else {
                        nextWord();
                    }
                }
            });
        });

        // Initialize game on load
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', loadVocabulary);
        } else {
            loadVocabulary();
        }
    </script>
</body>
</html>

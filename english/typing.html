<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>××©×—×§ ×”×§×œ×“×” - Typing Game</title>
    <script src="lesson-manager.js" onerror="console.log('lesson-manager.js not found, using basic mode')"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            text-align: center;
            max-width: 800px;
            width: 100%;
        }

        h1 {
            color: white;
            margin-bottom: 20px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        #lessonSelector {
            margin-bottom: 20px;
        }

        .score-section {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .score-box {
            background: rgba(255,255,255,0.2);
            padding: 15px 25px;
            border-radius: 10px;
            backdrop-filter: blur(10px);
            color: white;
            font-size: 1.2em;
        }

        .score-number {
            font-size: 1.8em;
            font-weight: bold;
            display: block;
        }

        .game-card {
            background: white;
            border-radius: 25px;
            padding: 50px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            margin-bottom: 20px;
        }

        .word-display {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 40px;
            border-radius: 20px;
            margin-bottom: 30px;
        }

        .english-word {
            color: white;
            font-size: 3.5em;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            margin-bottom: 10px;
        }

        .progress-text {
            color: rgba(255,255,255,0.9);
            font-size: 1.2em;
        }

        .input-section {
            margin-bottom: 30px;
        }

        .input-label {
            font-size: 1.3em;
            color: #666;
            margin-bottom: 15px;
            font-weight: bold;
        }

        .answer-input {
            width: 100%;
            padding: 20px;
            font-size: 2em;
            border: 3px solid #e0e0e0;
            border-radius: 15px;
            text-align: center;
            transition: all 0.3s;
            font-family: inherit;
        }

        .answer-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .answer-input.correct {
            border-color: #11998e;
            background: #e8f8f5;
        }

        .answer-input.wrong {
            border-color: #eb3349;
            background: #fde8ec;
        }

        .feedback {
            min-height: 60px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 1.5em;
            font-weight: bold;
            margin-bottom: 20px;
        }

        .feedback.correct {
            color: #11998e;
            animation: fadeIn 0.5s;
        }

        .feedback.wrong {
            color: #eb3349;
            animation: fadeIn 0.5s;
        }

        .feedback-icon {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .correct-answer {
            font-size: 0.8em;
            color: #666;
            margin-top: 10px;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .btn {
            padding: 15px 35px;
            font-size: 1.2em;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .btn-submit {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
        }

        .btn-skip {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }

        .btn-next {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* Complete Screen */
        .complete-screen {
            display: none;
            background: white;
            border-radius: 25px;
            padding: 60px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .complete-screen.active {
            display: block;
        }

        .complete-screen h2 {
            color: #667eea;
            font-size: 3em;
            margin-bottom: 30px;
        }

        .final-stats {
            font-size: 1.5em;
            margin: 30px 0;
            color: #666;
        }

        .final-stats div {
            margin: 15px 0;
        }

        .stat-highlight {
            font-size: 1.3em;
            font-weight: bold;
        }

        .restart-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 50px;
            font-size: 1.3em;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            font-weight: bold;
            margin: 10px;
        }

        .retry-btn {
            background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%);
            color: white;
            padding: 20px 50px;
            font-size: 1.3em;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            font-weight: bold;
            margin: 10px;
        }

        .hint {
            color: rgba(255,255,255,0.9);
            font-size: 1.1em;
            margin-top: 20px;
            font-style: italic;
        }

        @media (max-width: 600px) {
            h1 {
                font-size: 1.8em;
            }

            .game-card {
                padding: 30px 20px;
            }

            .english-word {
                font-size: 2.5em;
            }

            .answer-input {
                font-size: 1.5em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>âŒ¨ï¸ ××©×—×§ ×”×§×œ×“×” - Typing Game</h1>
        
        <div id="lessonSelector"></div>

        <div class="score-section">
            <div class="score-box">
                <span>âœ… × ×›×•× ×•×ª</span>
                <span class="score-number" id="correctScore">0</span>
            </div>
            <div class="score-box">
                <span>âŒ ×˜×¢×•×™×•×ª</span>
                <span class="score-number" id="wrongScore">0</span>
            </div>
        </div>

        <div class="game-card" id="gameArea">
            <div class="word-display">
                <div class="english-word" id="englishWord">Loading...</div>
                <div class="progress-text" id="progressText">××™×œ×” 1 ××ª×•×š 63</div>
            </div>

            <div class="input-section">
                <div class="input-label">×ª×¨×’× ×œ×¢×‘×¨×™×ª:</div>
                <input 
                    type="text" 
                    class="answer-input" 
                    id="answerInput" 
                    placeholder="×”×§×œ×“ ××ª ×”×ª×¨×’×•× ×›××Ÿ..."
                    autocomplete="off"
                >
            </div>

            <div class="feedback" id="feedback"></div>

            <div class="controls">
                <button class="btn btn-submit" id="submitBtn" onclick="checkAnswer()">
                    âœ“ ×‘×“×•×§ ×ª×©×•×‘×”
                </button>
                <button class="btn btn-skip" id="skipBtn" onclick="skipWord()">
                    â­ï¸ ×“×œ×’
                </button>
                <button class="btn btn-next" id="nextBtn" onclick="nextWord()" style="display: none;">
                    â¡ï¸ ×”×‘×
                </button>
            </div>
        </div>

        <div class="complete-screen" id="completeScreen">
            <h2>ğŸ‰ ×¡×™×™××ª!</h2>
            <div class="final-stats">
                <div>âœ… ×ª×©×•×‘×•×ª × ×›×•× ×•×ª: <span class="stat-highlight" id="finalCorrect">0</span></div>
                <div>âŒ ×˜×¢×•×™×•×ª: <span class="stat-highlight" id="finalWrong">0</span></div>
                <div>â­ï¸ ×“×™×œ×•×’×™×: <span class="stat-highlight" id="finalSkipped">0</span></div>
                <div>ğŸ“Š ×¦×™×•×Ÿ: <span class="stat-highlight" id="finalPercentage">0%</span></div>
            </div>
            <div>
                <button class="restart-btn" onclick="restartGame()">ğŸ”„ ×©×—×§ ×©×•×‘ (×›×œ ×”××™×œ×™×)</button>
                <button class="retry-btn" id="retryWrongBtn" onclick="retryWrong()" style="display: none;">
                    ğŸ’ª ×ª×¨×’×œ ××™×œ×™× ×©×˜×¢×™×ª
                </button>
            </div>
        </div>

        <div class="hint">
            ğŸ’¡ ×”×§×œ×“ ××ª ×”×ª×¨×’×•× ×‘×¢×‘×¨×™×ª ×•×œ×—×¥ Enter ××• ×¢×œ "×‘×“×•×§ ×ª×©×•×‘×”"
        </div>
    </div>

    <script>
        // ============================================
        // JSON ××•×˜××¢ (×‘×¨×™×¨×ª ××—×“×œ)
        // ============================================
        const EMBEDDED_VOCABULARY = [
            { "english": "area", "hebrew": "××–×•×¨" },
            { "english": "accompany", "hebrew": "×œ×œ×•×•×ª" },
            { "english": "bridge", "hebrew": "×’×©×¨" },
            { "english": "certain", "hebrew": "×‘×˜×•×—, ×•×“××™" },
            { "english": "danger", "hebrew": "×¡×›× ×”" },
            { "english": "dangerous", "hebrew": "××¡×•×›×Ÿ" },
            { "english": "improve", "hebrew": "×œ×©×¤×¨" },
            { "english": "imagine", "hebrew": "×œ×“××™×™×Ÿ" },
            { "english": "in fact", "hebrew": "×œ××¢×©×”, ×‘×¢×¦×" },
            { "english": "kilometer", "hebrew": "×§×™×œ×•××˜×¨" },
            { "english": "manage (to)", "hebrew": "×œ×”×¦×œ×™×— ×œ" },
            { "english": "article", "hebrew": "××××¨" },
            { "english": "be worth it", "hebrew": "×œ×”×™×•×ª ×©×•×•×”" },
            { "english": "blood", "hebrew": "×“×" },
            { "english": "common", "hebrew": "× ×¤×•×¥, ××¦×•×™" },
            { "english": "disease", "hebrew": "××—×œ×”" },
            { "english": "do (one's) best", "hebrew": "×œ×¢×©×•×ª ×›××™×˜×‘ ×™×›×•×œ×ª×•" },
            { "english": "emergency", "hebrew": "×—×™×¨×•×" },
            { "english": "fine", "hebrew": "×§× ×¡" },
            { "english": "health", "hebrew": "×‘×¨×™××•×ª" },
            { "english": "in case", "hebrew": "×‘××§×¨×” ×©" },
            { "english": "necessary", "hebrew": "×”×›×¨×—×™, × ×—×•×¥" },
            { "english": "obvious", "hebrew": "×‘×¨×•×¨, ××•×‘×Ÿ" },
            { "english": "one day", "hebrew": "×™×•× ××—×“" },
            { "english": "organize", "hebrew": "×œ××¨×’×Ÿ" },
            { "english": "patient (n)", "hebrew": "×—×•×œ×”" },
            { "english": "peace", "hebrew": "×©×œ×•×" },
            { "english": "pleased", "hebrew": "××¨×•×¦×”" },
            { "english": "suggest", "hebrew": "×œ×”×¦×™×¢" },
            { "english": "terrible", "hebrew": "× ×•×¨×" },
            { "english": "toothache", "hebrew": "×›××‘ ×©×™× ×™×™×" },
            { "english": "typical", "hebrew": "×˜×™×¤×•×¡×™" },
            { "english": "across", "hebrew": "××¢×‘×¨ ×œ" },
            { "english": "activity", "hebrew": "×¤×¢×™×œ×•×ª" },
            { "english": "be located in", "hebrew": "×œ×”×™×•×ª ×××•×§× ×‘" },
            { "english": "be made of", "hebrew": "×œ×”×™×•×ª ×¢×©×•×™ ×" },
            { "english": "carry", "hebrew": "×œ×©××ª, ×œ×¡×—×•×‘" },
            { "english": "distance", "hebrew": "××¨×—×§" },
            { "english": "fear (n)", "hebrew": "×¤×—×“" },
            { "english": "however", "hebrew": "××•×œ×, ×¢× ×–××ª" },
            { "english": "hurt (v)", "hebrew": "×œ×¤×’×•×¢, ×œ×”×›××™×‘" },
            { "english": "in time", "hebrew": "×‘×–××Ÿ" },
            { "english": "make sure (that)", "hebrew": "×œ×•×•×“× ×©" },
            { "english": "on foot", "hebrew": "×‘×¨×’×œ" },
            { "english": "ordinary", "hebrew": "×¨×’×™×œ" },
            { "english": "path", "hebrew": "×©×‘×™×œ" },
            { "english": "piece", "hebrew": "×—×ª×™×›×”" },
            { "english": "protect", "hebrew": "×œ×”×’×Ÿ" },
            { "english": "reach", "hebrew": "×œ×”×’×™×¢" },
            { "english": "really", "hebrew": "×‘×××ª" },
            { "english": "responsibility", "hebrew": "××—×¨×™×•×ª" },
            { "english": "simple", "hebrew": "×¤×©×•×˜" },
            { "english": "stay (v)", "hebrew": "×œ×”×™×©××¨" },
            { "english": "suddenly", "hebrew": "×¤×ª××•×" },
            { "english": "themselves", "hebrew": "×¢×¦××" },
            { "english": "be willing to", "hebrew": "×œ×”×™×•×ª ××•×›×Ÿ ×œ" },
            { "english": "closing time", "hebrew": "×©×¢×ª ×¡×’×™×¨×”" },
            { "english": "definitely", "hebrew": "×‘×”×—×œ×˜" },
            { "english": "diploma", "hebrew": "×ª×¢×•×“×”" },
            { "english": "involve", "hebrew": "×œ×›×œ×•×œ, ×œ×¢×¨×‘" },
            { "english": "by", "hebrew": "×œ×™×“, ×¢×œ ×™×“×™" },
            { "english": "local", "hebrew": "××§×•××™" },
            { "english": "open (v)", "hebrew": "×œ×¤×ª×•×—" },
            { "english": "opportunity", "hebrew": "×”×–×“×× ×•×ª" }
        ];

        let vocabulary = EMBEDDED_VOCABULARY;
        let words = [];
        let currentIndex = 0;
        let correctCount = 0;
        let wrongCount = 0;
        let skippedCount = 0;
        let wrongWords = [];
        let hasAnswered = false;
        let isRetryMode = false;

        const encouragingMessages = [
            "ğŸ‰ ××¦×•×™×Ÿ!",
            "ğŸ’ª ×›×œ ×”×›×‘×•×“!",
            "â­ × ×”×“×¨!",
            "ğŸŒŸ ××¢×•×œ×”!",
            "ğŸ‘ ×™×¤×” ×××•×“!",
            "ğŸ”¥ ××©!",
            "ğŸš€ ×¤×¦×¦×”!",
            "ğŸ’ ××•×©×œ×!",
            "ğŸ† ××œ×•×£!",
            "âœ¨ ×™×¤×”!"
        ];

        function shuffleArray(array) {
            const newArray = [...array];
            for (let i = newArray.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
            }
            return newArray;
        }

        function normalizeHebrew(text) {
            // Remove extra spaces, trim, and normalize
            return text.trim().replace(/\s+/g, ' ').toLowerCase();
        }

        function isAnswerCorrect(userAnswer, correctAnswer) {
            const normalized1 = normalizeHebrew(userAnswer);
            const normalized2 = normalizeHebrew(correctAnswer);
            
            // Check if answers are the same
            if (normalized1 === normalized2) return true;
            
            // Check if correctAnswer has multiple options (separated by comma)
            const options = correctAnswer.split(',').map(opt => normalizeHebrew(opt));
            return options.some(opt => opt === normalized1);
        }

        async function loadVocabulary() {
            // Check if LessonManager exists
            if (typeof LessonManager !== 'undefined') {
                await LessonManager.init(EMBEDDED_VOCABULARY);
                LessonManager.createLessonSelector('lessonSelector', onLessonChange);
                initializeGame();
            } else {
                // Fallback: load directly without lesson support
                try {
                    const response = await fetch('vocabulary.json');
                    if (response.ok) {
                        const data = await response.json();
                        
                        // Check if new structure (with lessons array)
                        if (data.lessons && Array.isArray(data.lessons)) {
                            vocabulary = data.lessons.flatMap(lesson => lesson.words);
                            console.log('âœ… Vocabulary loaded from JSON (all lessons)');
                        } else {
                            vocabulary = data;
                            console.log('âœ… Vocabulary loaded from JSON');
                        }
                    } else {
                        console.log('â„¹ï¸ Using embedded vocabulary');
                    }
                } catch (error) {
                    console.log('â„¹ï¸ Using embedded vocabulary');
                }
                initializeGame();
            }
        }

        function onLessonChange(lesson) {
            correctCount = 0;
            wrongCount = 0;
            skippedCount = 0;
            wrongWords = [];
            document.getElementById('correctScore').textContent = '0';
            document.getElementById('wrongScore').textContent = '0';
            initializeGame();
        }

        function initializeGame() {
            if (typeof LessonManager !== 'undefined') {
                vocabulary = LessonManager.getCurrentVocabulary();
            }
            words = shuffleArray([...vocabulary]);
            currentIndex = 0;
            displayWord();
        }

        function displayWord() {
            if (currentIndex >= words.length) {
                showCompleteScreen();
                return;
            }

            hasAnswered = false;
            const word = words[currentIndex];
            
            document.getElementById('englishWord').textContent = word.english;
            document.getElementById('progressText').textContent = `××™×œ×” ${currentIndex + 1} ××ª×•×š ${words.length}`;
            document.getElementById('answerInput').value = '';
            document.getElementById('answerInput').className = 'answer-input';
            document.getElementById('answerInput').disabled = false;
            document.getElementById('feedback').innerHTML = '';
            document.getElementById('feedback').className = 'feedback';
            
            document.getElementById('submitBtn').style.display = 'inline-block';
            document.getElementById('skipBtn').style.display = 'inline-block';
            document.getElementById('nextBtn').style.display = 'none';
            
            // Focus on input
            document.getElementById('answerInput').focus();
        }

        function checkAnswer() {
            if (hasAnswered) return;
            
            const userAnswer = document.getElementById('answerInput').value.trim();
            if (!userAnswer) {
                alert('×× × ×”×§×œ×“ ×ª×©×•×‘×”');
                return;
            }
            
            hasAnswered = true;
            const word = words[currentIndex];
            const input = document.getElementById('answerInput');
            const feedback = document.getElementById('feedback');
            
            input.disabled = true;
            document.getElementById('submitBtn').style.display = 'none';
            document.getElementById('skipBtn').style.display = 'none';
            document.getElementById('nextBtn').style.display = 'inline-block';
            
            if (isAnswerCorrect(userAnswer, word.hebrew)) {
                input.classList.add('correct');
                correctCount++;
                document.getElementById('correctScore').textContent = correctCount;
                
                const randomMessage = encouragingMessages[Math.floor(Math.random() * encouragingMessages.length)];
                feedback.innerHTML = `<div class="feedback-icon">âœ…</div><div>${randomMessage}</div>`;
                feedback.className = 'feedback correct';
            } else {
                input.classList.add('wrong');
                wrongCount++;
                document.getElementById('wrongScore').textContent = wrongCount;
                
                // Track wrong word
                if (!wrongWords.find(w => w.english === word.english)) {
                    wrongWords.push(word);
                }
                
                feedback.innerHTML = `
                    <div class="feedback-icon">âŒ</div>
                    <div>×œ× × ×›×•×Ÿ</div>
                    <div class="correct-answer">×”×ª×©×•×‘×” ×”× ×›×•× ×”: ${word.hebrew}</div>
                `;
                feedback.className = 'feedback wrong';
            }
        }

        function skipWord() {
            if (hasAnswered) return;
            
            const word = words[currentIndex];
            const feedback = document.getElementById('feedback');
            
            skippedCount++;
            
            // Track as wrong word for retry
            if (!wrongWords.find(w => w.english === word.english)) {
                wrongWords.push(word);
            }
            
            feedback.innerHTML = `
                <div class="feedback-icon">â­ï¸</div>
                <div>×“×™×œ×’×ª</div>
                <div class="correct-answer">×”×ª×©×•×‘×”: ${word.hebrew}</div>
            `;
            feedback.className = 'feedback';
            
            hasAnswered = true;
            document.getElementById('answerInput').disabled = true;
            document.getElementById('submitBtn').style.display = 'none';
            document.getElementById('skipBtn').style.display = 'none';
            document.getElementById('nextBtn').style.display = 'inline-block';
        }

        function nextWord() {
            currentIndex++;
            displayWord();
        }

        function showCompleteScreen() {
            document.getElementById('gameArea').style.display = 'none';
            document.getElementById('completeScreen').style.display = 'block';
            
            const total = words.length;
            const percentage = Math.round((correctCount / total) * 100);
            
            document.getElementById('finalCorrect').textContent = correctCount;
            document.getElementById('finalWrong').textContent = wrongCount;
            document.getElementById('finalSkipped').textContent = skippedCount;
            document.getElementById('finalPercentage').textContent = `${percentage}%`;
            
            // Show retry button if there are wrong words
            if (wrongWords.length > 0) {
                const retryBtn = document.getElementById('retryWrongBtn');
                retryBtn.style.display = 'inline-block';
                retryBtn.textContent = `ğŸ’ª ×ª×¨×’×œ ××™×œ×™× ×©×˜×¢×™×ª (${wrongWords.length} ××™×œ×™×)`;
            }
        }

        function restartGame() {
            words = shuffleArray([...vocabulary]);
            currentIndex = 0;
            correctCount = 0;
            wrongCount = 0;
            skippedCount = 0;
            wrongWords = [];
            isRetryMode = false;
            
            document.getElementById('correctScore').textContent = '0';
            document.getElementById('wrongScore').textContent = '0';
            document.getElementById('gameArea').style.display = 'block';
            document.getElementById('completeScreen').style.display = 'none';
            
            displayWord();
        }

        function retryWrong() {
            words = shuffleArray([...wrongWords]);
            currentIndex = 0;
            correctCount = 0;
            wrongCount = 0;
            skippedCount = 0;
            isRetryMode = true;
            
            document.getElementById('correctScore').textContent = '0';
            document.getElementById('wrongScore').textContent = '0';
            document.getElementById('gameArea').style.display = 'block';
            document.getElementById('completeScreen').style.display = 'none';
            
            displayWord();
        }

        // Enter key support
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('answerInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    if (!hasAnswered) {
                        checkAnswer();
                    } else {
                        nextWord();
                    }
                }
            });
        });

        // Initialize game on load
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', loadVocabulary);
        } else {
            loadVocabulary();
        }
    </script>
</body>
</html>
